"use strict";(self.webpackChunkpodman=self.webpackChunkpodman||[]).push([[51157],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>h});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),p=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},m="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),m=p(n),d=r,h=m["".concat(l,".").concat(d)]||m[d]||u[d]||o;return n?a.createElement(h,i(i({ref:t},c),{},{components:n})):a.createElement(h,i({ref:t},c))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[m]="string"==typeof e?e:r,i[1]=s;for(var p=2;p<o;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},25840:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>u,frontMatter:()=>o,metadata:()=>s,toc:()=>p});var a=n(87462),r=(n(67294),n(3905));const o={title:"Adding checkpoint/restore support to Podman",layout:"default",author:"Adrian Reber",categories:["blogs"],tags:["podman","containers"]},i=void 0,s={permalink:"/blogs/2018/10/10/checkpoint-restore",source:"@site/blog/2018-10-10-checkpoint-restore.md",title:"Adding checkpoint/restore support to Podman",description:"podman logo",date:"2018-10-10T00:00:00.000Z",formattedDate:"October 10, 2018",tags:[{label:"podman",permalink:"/blogs/tags/podman"},{label:"containers",permalink:"/blogs/tags/containers"}],readingTime:4.2,hasTruncateMarker:!0,authors:[{name:"Adrian Reber"}],frontMatter:{title:"Adding checkpoint/restore support to Podman",layout:"default",author:"Adrian Reber",categories:["blogs"],tags:["podman","containers"]},prevItem:{title:"Buildah and Podman Relationship",permalink:"/blogs/2018/10/31/podman-buildah-relationship"},nextItem:{title:"OpenStack Containerization with Podman \u2013 Part 3 (Upgrades)",permalink:"/blogs/2018/10/07/tripleo-upgrade"}},l={authorsImageUrls:[void 0]},p=[{value:"By Adrian Reber",id:"by-adrian-reber",level:2}],c={toc:p},m="wrapper";function u(e){let{components:t,...o}=e;return(0,r.kt)(m,(0,a.Z)({},c,o,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"podman logo",src:n(1382).Z,width:"228",height:"61"})),(0,r.kt)("h1",{id:"adding-checkpointrestore-support-to-podman"},"Adding checkpoint/restore support to Podman"),(0,r.kt)("h2",{id:"by-adrian-reber"},"By Adrian Reber"),(0,r.kt)("p",null,"With the help of ",(0,r.kt)("a",{parentName:"p",href:"https://criu.org"},"Checkpoint/Restore In Userspace (CRIU)")," I\nwas able to add initial checkpoint/restore support to Podman. Using\ncheckpoint/restore it is now possible to resume a container after a reboot at\nexactly the same point in time it was checkpointed."),(0,r.kt)("p",null,"In January 2018 I started to think about bringing checkpoint/restore support to\nPodman. After a few initial discussions I started to actually look at the\nnecessary code changes. As Podman uses\n",(0,r.kt)("a",{parentName:"p",href:"https://github.com/opencontainers/runc"},"runc")," to run containers the initial\nsupport for checkpointing containers was implemented pretty fast. Restoring was\na bit more complicated as it required additional changes to\n",(0,r.kt)("a",{parentName:"p",href:"https://github.com/kubernetes-sigs/cri-o/pull/1427"},"conmon"),"."),(0,r.kt)("p",null,"At that point I was able to checkpoint and restore a simple container."),(0,r.kt)("p",null,"To make checkpointing and restoring containers actually useful the restored\ncontainer needs to have the same IP address as the checkpointed container. That\nwas the point where the implementation got a bit complicated."),(0,r.kt)("p",null,"Although having worked on and with different container runtime's\ncheckpoint/restore support I never had a closer look at the networking setup.\nIt always worked. With Podman it did not at the beginning. The biggest\ndifference is, as far as I understand it right now, is that Podman uses\n",(0,r.kt)("a",{parentName:"p",href:"https://github.com/containernetworking/cni"},"Container Network Interface (CNI)"),"\nto configure the container's network. CNI creates a network namespace and after\nconfiguring it tells ",(0,r.kt)("inlineCode",{parentName:"p"},"runc")," to use that network namespace for the container."),(0,r.kt)("p",null,"The difference with this setup is that other container runtimes did not really\ncare about the actual name of the network namespace and CRIU just created on\nrestore a ",(0,r.kt)("strong",{parentName:"p"},"new")," network namespace with the same properties as during checkpoint.\nSo a new network namespace was created. For Podman this needs to be different.\nCRIU needs to ignore/skip the network namespace and to handle this correctly I\nhad to adapt runc\n(",(0,r.kt)("a",{parentName:"p",href:"https://github.com/opencontainers/runc/pull/1849"},"Add support to checkpoint and restore into external network namespaces"),")\nas well as CRIU\n(",(0,r.kt)("a",{parentName:"p",href:"https://github.com/checkpoint-restore/criu/commit/a8a3eb902305f0af603afa4c95b1b632fe7bd149"},"criu: add support for external net namespaces "),")."),(0,r.kt)("p",null,"So after spending time on ",(0,r.kt)("inlineCode",{parentName:"p"},"runc")," and CRIU I was able to return to Podman and\nimplement the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/containers/podman/pull/469"},"necessary changes"),"\nwhich have been merged into Podman at the beginning of October 2018."),(0,r.kt)("p",null,"With all the background information out of the way, now finally some examples\nhow checkpoint/restore can be used in Podman. In my example I am using a\ncontainer running ",(0,r.kt)("a",{parentName:"p",href:"https://tomcat.apache.org/"},"Apache Tomcat")," with a slightly\nmodified HelloWorldExample. The HelloWorldExample has been modified to return\na single integer which is is incremented after each request."),(0,r.kt)("p",null,"The following starts my test container:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'# podman run --security-opt="seccomp=unconfined" --tmpfs /tmp --name podman-criu-test -d docker://docker.io/yovfiatbeb/podman-criu-test\n')),(0,r.kt)("p",null,"As I am running my tests on a RHEL7 system I have to add\n",(0,r.kt)("inlineCode",{parentName:"p"},'--security-opt="seccomp=unconfined"')," because CRIU cannot correctly handle\n",(0,r.kt)("inlineCode",{parentName:"p"},"seccomp")," on RHEL7. The option ",(0,r.kt)("inlineCode",{parentName:"p"},"--tmpfs /tmp")," is necessary as ",(0,r.kt)("inlineCode",{parentName:"p"},"tomcat")," creates\ntemporary files in ",(0,r.kt)("inlineCode",{parentName:"p"},"/tmp")," which are only correctly restored by CRIU if ",(0,r.kt)("inlineCode",{parentName:"p"},"/tmp"),"\nis a ",(0,r.kt)("inlineCode",{parentName:"p"},"tmpfs"),"."),(0,r.kt)("p",null,"Once the container is up and running I can use ",(0,r.kt)("inlineCode",{parentName:"p"},"curl")," to make requests to ",(0,r.kt)("inlineCode",{parentName:"p"},"tomcat"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"$ curl 10.22.0.53:8080/examples/servlets/servlet/HelloWorldExample\n1\n$ curl 10.22.0.53:8080/examples/servlets/servlet/HelloWorldExample\n2\n")),(0,r.kt)("p",null,"I can now checkpoint the container:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"# podman container checkpoint podman-criu-test\n")),(0,r.kt)("p",null,"Now the container is no longer running and could be restored. If I would\nrestore the container now the result would basically be the same as pausing and\nunpausing the container. To make checkpointing useful I am now rebooting the\nsystem before restoring the container. Once the system is up again I can\nrestore the container:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"# podman container restore --keep podman-criu-test\n")),(0,r.kt)("p",null,"Using ",(0,r.kt)("inlineCode",{parentName:"p"},"curl")," to make requests to the container the result will now ",(0,r.kt)("strong",{parentName:"p"},"not")," start at\n'1' again, but continue at the previous value:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"$ curl 10.22.0.53:8080/examples/servlets/servlet/HelloWorldExample\n3\n$ curl 10.22.0.53:8080/examples/servlets/servlet/HelloWorldExample\n4\n$ curl 10.22.0.53:8080/examples/servlets/servlet/HelloWorldExample\n5\n")),(0,r.kt)("p",null,"As I have been using the ",(0,r.kt)("inlineCode",{parentName:"p"},"--keep")," flag during restore, Podman has not deleted\nthe checkpoint after the restore, which would be the normal operation. If I\nreboot the system again I can restore the container again:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"$ podman container restore --keep podman-criu-test\n")),(0,r.kt)("p",null,"And now the result from ",(0,r.kt)("inlineCode",{parentName:"p"},"curl")," is the same as before:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"$ curl 10.22.0.53:8080/examples/servlets/servlet/HelloWorldExample\n3\n$ curl 10.22.0.53:8080/examples/servlets/servlet/HelloWorldExample\n4\n$ curl 10.22.0.53:8080/examples/servlets/servlet/HelloWorldExample\n5\n")),(0,r.kt)("p",null,"So right now checkpointing and restoring can be used as either a stateful\npause/unpause between reboots or as way to go back in time of the container's\nlife."),(0,r.kt)("p",null,"I recorded all those steps in the demo below:"),(0,r.kt)("a",{href:"https://asciinema.org/a/FsTbx9mZkzeuhCM2pFOr1tujM",target:"_blank"},(0,r.kt)("img",{src:"https://asciinema.org/a/FsTbx9mZkzeuhCM2pFOr1tujM.png",width:"650"})),(0,r.kt)("p",null,"The checkpoint/restore support in Podman is still very new and requires a git\ncheckout of CRIU using the ",(0,r.kt)("inlineCode",{parentName:"p"},"criu-dev")," branch to work right now. The necessary\nCRIU changes will be in the upcoming CRIU 3.11 release. ",(0,r.kt)("inlineCode",{parentName:"p"},"runc")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"conmon"),"\nalso need to be new enough for checkpoint/restore to work."),(0,r.kt)("p",null,"Currently only checkpoint/restore on the same system is supported, but to\nmake this feature really interesting it would be nice to be able to\nmigrate containers. To make container migration easy I want to offer\nthe possibility to easily export the checkpoint and appropriate container\nstate from one Podman instance to another Podman instance to be able to\nrestore the checkpointed container."))}u.isMDXComponent=!0},1382:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/podman-ce586c2894883ad9c353492b5e1893a8.svg"}}]);