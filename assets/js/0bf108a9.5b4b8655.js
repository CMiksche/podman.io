"use strict";(self.webpackChunkpodman=self.webpackChunkpodman||[]).push([[1987],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>h});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var d=a.createContext({}),l=function(e){var t=a.useContext(d),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=l(e.components);return a.createElement(d.Provider,{value:t},e.children)},c="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,d=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),c=l(n),m=r,h=c["".concat(d,".").concat(m)]||c[m]||u[m]||o;return n?a.createElement(h,i(i({ref:t},p),{},{components:n})):a.createElement(h,i({ref:t},p))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=m;var s={};for(var d in t)hasOwnProperty.call(t,d)&&(s[d]=t[d]);s.originalType=e,s[c]="string"==typeof e?e:r,i[1]=s;for(var l=2;l<o;l++)i[l]=n[l];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},4967:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>i,default:()=>u,frontMatter:()=>o,metadata:()=>s,toc:()=>l});var a=n(7462),r=(n(7294),n(3905));const o={},i=void 0,s={unversionedId:"podman-auto-update",id:"podman-auto-update",title:"podman-auto-update",description:"% podman-auto-update 1",source:"@site/docs/podman-auto-update.md",sourceDirName:".",slug:"/podman-auto-update",permalink:"/websites-new/docs/podman-auto-update",draft:!1,editUrl:"https://github.com/containers/website-new/docs/podman-auto-update.md",tags:[],version:"current",frontMatter:{},sidebar:"docsSidebar",previous:{title:"podman-attach",permalink:"/websites-new/docs/podman-attach"},next:{title:"podman-build",permalink:"/websites-new/docs/podman-build"}},d={},l=[{value:"NAME",id:"name",level:2},{value:"SYNOPSIS",id:"synopsis",level:2},{value:"DESCRIPTION",id:"description",level:2},{value:"Auto Updates and Kubernetes YAML",id:"auto-updates-and-kubernetes-yaml",level:3},{value:"Systemd Unit and Timer",id:"systemd-unit-and-timer",level:3},{value:"OPTIONS",id:"options",level:2},{value:"<strong>--dry-run</strong>",id:"--dry-run",level:4},{value:"<strong>--format</strong>=<em>format</em>",id:"--formatformat",level:4},{value:"<strong>--rollback</strong>",id:"--rollback",level:4},{value:"EXAMPLES",id:"examples",level:2},{value:"SEE ALSO",id:"see-also",level:2}],p={toc:l},c="wrapper";function u(e){let{components:t,...n}=e;return(0,r.kt)(c,(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"% podman-auto-update 1"),(0,r.kt)("h2",{id:"name"},"NAME"),(0,r.kt)("p",null,"podman","-","auto-update - Auto update containers according to their auto-update policy"),(0,r.kt)("h2",{id:"synopsis"},"SYNOPSIS"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"podman auto-update")," ","[",(0,r.kt)("em",{parentName:"p"},"options"),"]"),(0,r.kt)("h2",{id:"description"},"DESCRIPTION"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"podman auto-update")," looks up containers with a specified ",(0,r.kt)("inlineCode",{parentName:"p"},"io.containers.autoupdate")," label (i.e., the auto-update policy)."),(0,r.kt)("p",null,"If the label is present and set to ",(0,r.kt)("inlineCode",{parentName:"p"},"registry"),", Podman reaches out to the corresponding registry to check if the image has been updated. The label ",(0,r.kt)("inlineCode",{parentName:"p"},"image")," is an alternative to ",(0,r.kt)("inlineCode",{parentName:"p"},"registry")," maintained for backwards compatibility.\nAn image is considered updated if the digest in the local storage is different than the one of the remote image.\nIf an image must be updated, Podman pulls it down and restarts the systemd unit executing the container."),(0,r.kt)("p",null,"The registry policy requires a fully-qualified image reference (e.g., quay.io/podman/stable:latest) to be used to create the container.\nThis enforcement is necessary to know which image to actually check and pull.\nIf an image ID was used, Podman would not know which image to check/pull anymore."),(0,r.kt)("p",null,"Alternatively, if the autoupdate label is set to ",(0,r.kt)("inlineCode",{parentName:"p"},"local"),", Podman will compare the image a container is using to the image with its raw name in local storage.\nIf an image is updated locally, Podman simply restarts the systemd unit executing the container."),(0,r.kt)("p",null,"If ",(0,r.kt)("inlineCode",{parentName:"p"},"io.containers.autoupdate.authfile")," label is present, Podman reaches out to the corresponding authfile when pulling images."),(0,r.kt)("p",null,"At container-creation time, Podman looks up the ",(0,r.kt)("inlineCode",{parentName:"p"},"PODMAN_SYSTEMD_UNIT")," environment variable and stores it verbatim in the container's label.\nThis variable is now set by all systemd units generated by ",(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("a",{parentName:"strong",href:"/websites-new/docs/podman-generate/podman-generate-systemd"},"podman-generate-systemd"))," and is set to ",(0,r.kt)("inlineCode",{parentName:"p"},"%n")," (i.e., the name of systemd unit starting the container).\nThis data is then being used in the auto-update sequence to instruct systemd (via DBUS) to restart the unit and hence to restart the container."),(0,r.kt)("p",null,"If a container configured for auto updates is part of a pod, the pod's systemd unit will be restarted and hence the entire pod and all containers inside the pod. Container updates are batched, such that a pod gets restarted at most once."),(0,r.kt)("p",null,"Note that ",(0,r.kt)("strong",{parentName:"p"},"podman auto-update")," relies on systemd. The systemd units are expected to be generated with ",(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("a",{parentName:"strong",href:"/websites-new/docs/podman-generate/podman-generate-systemd#--new"},"podman-generate-systemd --new")),", or similar units that create new containers in order to run the updated images.\nSystemd units that start and stop a container cannot run a new image."),(0,r.kt)("h3",{id:"auto-updates-and-kubernetes-yaml"},"Auto Updates and Kubernetes YAML"),(0,r.kt)("p",null,"Podman supports auto updates for Kubernetes workloads. As mentioned above, ",(0,r.kt)("inlineCode",{parentName:"p"},"podman auto-update")," requires the containers to be running systemd. Podman ships with a systemd template that can be instantiated with a Kubernetes YAML file, see podman-generate-systemd(1)."),(0,r.kt)("p",null,"To enable auto updates for containers running in a Kubernetes workload, set the following Podman-specific annotations in the YAML:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},'io.containers.autoupdate: "registry|local"')," to apply the auto-update policy to all containers"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},'io.containers.autoupdate/$container: "registry|local"')," to apply the auto-update policy to ",(0,r.kt)("inlineCode",{parentName:"li"},"$container")," only"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},'io.containers.sdnotify: "conmon|container"')," to apply the sdnotify policy to all containers"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},'io.containers.sdnotify/$container: "conmon|container"')," to apply the sdnotify policy to ",(0,r.kt)("inlineCode",{parentName:"li"},"$container")," only")),(0,r.kt)("p",null,'By default, the autoupdate policy is set to "disabled", the sdnotify policy is set to "conmon".'),(0,r.kt)("h3",{id:"systemd-unit-and-timer"},"Systemd Unit and Timer"),(0,r.kt)("p",null,"Podman ships with a ",(0,r.kt)("inlineCode",{parentName:"p"},"podman-auto-update.service")," systemd unit. This unit is triggered daily at midnight by the ",(0,r.kt)("inlineCode",{parentName:"p"},"podman-auto-update.timer")," systemd timer. The timer can be altered for custom time-based updates if desired. The unit can further be invoked by other systemd units (e.g., via the dependency tree) or manually via ",(0,r.kt)("strong",{parentName:"p"},"systemctl start podman-auto-update.service"),"."),(0,r.kt)("h2",{id:"options"},"OPTIONS"),(0,r.kt)("p",null,"@@option authfile"),(0,r.kt)("h4",{id:"--dry-run"},(0,r.kt)("strong",{parentName:"h4"},"--dry-run")),(0,r.kt)("p",null,"Check for the availability of new images but do not perform any pull operation or restart any service or container.\nThe ",(0,r.kt)("inlineCode",{parentName:"p"},"UPDATED"),' field indicates the availability of a new image with "pending".'),(0,r.kt)("h4",{id:"--formatformat"},(0,r.kt)("strong",{parentName:"h4"},"--format"),"=",(0,r.kt)("em",{parentName:"h4"},"format")),(0,r.kt)("p",null,"Change the default output format. This can be of a supported type like 'json' or a Go template.\nValid placeholders for the Go template are listed below:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"th"},"Placeholder")),(0,r.kt)("th",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"th"},"Description")))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},".Container"),(0,r.kt)("td",{parentName:"tr",align:null},"ID and name of the container")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},".ContainerID"),(0,r.kt)("td",{parentName:"tr",align:null},"ID of the container")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},".ContainerName"),(0,r.kt)("td",{parentName:"tr",align:null},"Name of the container")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},".Image"),(0,r.kt)("td",{parentName:"tr",align:null},"Name of the image")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},".Policy"),(0,r.kt)("td",{parentName:"tr",align:null},"Auto-update policy of the container")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},".Unit"),(0,r.kt)("td",{parentName:"tr",align:null},"Name of the systemd unit")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},".Updated"),(0,r.kt)("td",{parentName:"tr",align:null},"Update status: true,false,failed")))),(0,r.kt)("h4",{id:"--rollback"},(0,r.kt)("strong",{parentName:"h4"},"--rollback")),(0,r.kt)("p",null,"If restarting a systemd unit after updating the image has failed, rollback to using the previous image and restart the unit another time. Default is true."),(0,r.kt)("p",null,"Please note that detecting if a systemd unit has failed is best done by the container sending the READY message via SDNOTIFY. This way, restarting the unit will wait until having received the message or a timeout kicked in. Without that, restarting the systemd unit may succeed even if the container has failed shortly after."),(0,r.kt)("p",null,"For a container to send the READY message via SDNOTIFY it must be created with the ",(0,r.kt)("inlineCode",{parentName:"p"},"--sdnotify=container")," option (see podman-run(1)). The application running inside the container can then execute ",(0,r.kt)("inlineCode",{parentName:"p"},"systemd-notify --ready")," when ready or use the sdnotify bindings of the specific programming language (e.g., sd_notify(3))."),(0,r.kt)("h2",{id:"examples"},"EXAMPLES"),(0,r.kt)("p",null,"Autoupdate with registry policy"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'### Start a container\n$ podman run --label "io.containers.autoupdate=registry" \\\n    --label "io.containers.autoupdate.authfile=/some/authfile.json" \\\n    -d --name=test registry.fedoraproject.org/fedora:latest sleep infinity\nbc219740a210455fa27deacc96d50a9e20516492f1417507c13ce1533dbdcd9d\n\n### Generate a systemd unit for this container\n$ podman generate systemd --new --files bc219740a210455fa27deacc96d50a9e20516492f1417507c13ce1533dbdcd9d\n/home/user/container-bc219740a210455fa27deacc96d50a9e20516492f1417507c13ce1533dbdcd9d.service\n\n### Load the new systemd unit and start it\n$ mv ./container-bc219740a210455fa27deacc96d50a9e20516492f1417507c13ce1533dbdcd9d.service ~/.config/systemd/user/container-test.service\n$ systemctl --user daemon-reload\n\n### If the previously created containers or pods are using shared resources, such as ports, make sure to remove them before starting the generated systemd units.\n$ podman stop bc219740a210455fa27deacc96d50a9e20516492f1417507c13ce1533dbdcd9d\n$ podman rm bc219740a210455fa27deacc96d50a9e20516492f1417507c13ce1533dbdcd9d\n\n$ systemctl --user start container-test.service\n\n### Check if a newer image is available\n$ podman auto-update --dry-run --format "{{.Image}} {{.Updated}}"\nregistry.fedoraproject.org/fedora:latest   pending\n\n### Autoupdate the services\n$ podman auto-update\nUNIT                    CONTAINER            IMAGE                                     POLICY      UPDATED\ncontainer-test.service  08fd34e533fd (test)  registry.fedoraproject.org/fedora:latest  registry    false\n')),(0,r.kt)("p",null,"Autoupdate with local policy"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'### Start a container\n$ podman run --label "io.containers.autoupdate=local" \\\n    -d busybox:latest top\nbe0889fd06f252a2e5141b37072c6bada68563026cb2b2649f53394d87ccc338\n\n### Generate a systemd unit for this container\n$ podman generate systemd --new --files be0889fd06f252a2e5141b37072c6bada68563026cb2b2649f53394d87ccc338\n/home/user/container-be0889fd06f252a2e5141b37072c6bada68563026cb2b2649f53394d87ccc338.service\n\n### Load the new systemd unit and start it\n$ mv ./container-be0889fd06f252a2e5141b37072c6bada68563026cb2b2649f53394d87ccc338.service ~/.config/systemd/user\n$ systemctl --user daemon-reload\n\n### If the previously created containers or pods are using shared resources, such as ports, make sure to remove them before starting the generated systemd units.\n$ podman stop be0889fd06f252a2e5141b37072c6bada68563026cb2b2649f53394d87ccc338\n$ podman rm be0889fd06f252a2e5141b37072c6bada68563026cb2b2649f53394d87ccc338\n\n$ systemctl --user start container-be0889fd06f252a2e5141b37072c6bada68563026cb2b2649f53394d87ccc338.service\n\n### Get the name of the container\n$ podman ps\nCONTAINER ID  IMAGE                             COMMAND  CREATED        STATUS        PORTS   NAMES\n01f5c8113e84  docker.io/library/busybox:latest  top      2 seconds ago  Up 3 seconds          inspiring_galileo\n\n### Modify the image\n$ podman commit --change CMD=/bin/bash inspiring_galileo busybox:latest\n\n### Auto-update the container\n$ podman auto-update\n[...]\n')),(0,r.kt)("h2",{id:"see-also"},"SEE ALSO"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("a",{parentName:"strong",href:"/websites-new/docs/podman"},"podman(1)")),", ",(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("a",{parentName:"strong",href:"/websites-new/docs/podman-generate/podman-generate-systemd"},"podman-generate-systemd(1)")),", ",(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("a",{parentName:"strong",href:"/websites-new/docs/podman-run"},"podman-run(1)")),", ",(0,r.kt)("strong",{parentName:"p"},"sd_notify(3)"),", ",(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("a",{parentName:"strong",href:"https://www.freedesktop.org/software/systemd/man/systemd.unit.html"},"systemd.unit(5)"))))}u.isMDXComponent=!0}}]);